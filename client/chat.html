<!DOCTYPE html>
<html lang="en">
<head>
  <title>WebChat</title>

  <!-- ðŸ”¥ MOBILE RESPONSIVE ROOT -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    /* ===== GLOBAL RESET ===== */
    html{
      font-size:16px;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    *{
      box-sizing:border-box;
      font-family:"Segoe UI Emoji","Segoe UI",Roboto,Arial,sans-serif;
    }

    html, body{
      margin:0;
      padding:0;
      height:100%;
      background:#0b141a;
      overflow-x:hidden;
    }

    /* ===== APP ===== */
    .app{
      height:100svh;
      width:100%;
      display:flex;
      flex-direction:column;
      background:#efeae2;
    }

    /* ===== HEADER ===== */
    .header{
      flex-shrink:0;
      padding:14px 16px;
      background:#202c33;
      color:#e9edef;
      font-size:18px;
      font-weight:600;
    }

    /* ===== MESSAGES ===== */
    .messages{
      flex:1 1 auto;
      padding:14px 16px;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      background:
        linear-gradient(rgba(229,221,213,0.92), rgba(229,221,213,0.92)),
        url("https://i.imgur.com/8IuucQZ.png");
      background-repeat:repeat;
      background-size:auto;
    }

    /* ===== MESSAGE BUBBLES ===== */
    .left,
    .right{
      max-width:85%;
      width:fit-content;
      padding:10px 14px;
      margin:6px 0;
      border-radius:8px;
      font-size:16px;
      line-height:1.55;
      white-space:pre-wrap;
      animation:msgIn 0.15s ease-out;
    }

    .left{ background:#ffffff; }
    .right{ background:#d9fdd3; margin-left:auto; }

    /* ===== INPUT BAR ===== */
    .input-bar{
      flex-shrink:0;
      padding:10px;
      background:#f0f2f5;
      border-top:1px solid #ddd;
      display:flex;
      gap:8px;
      align-items:flex-end;
    }

    .input-bar textarea{
      flex:1;
      resize:none;
      padding:12px 14px;
      font-size:16px;
      border:none;
      border-radius:18px;
      outline:none;
      max-height:120px;
      overflow-y:auto;
    }

    /* SEND BUTTON (hidden on desktop) */
    #sendBtn{
      display:none;
      padding:12px 14px;
      font-size:18px;
      border:none;
      border-radius:50%;
      background:#00a884;
      color:white;
      cursor:pointer;
    }

    /* SHOW SEND BUTTON ON PHONE */
    @media (max-width:600px){
      #sendBtn{
        display:block;
      }
    }

    /* ===== ANIMATION ===== */
    @keyframes msgIn{
      from{ opacity:0; transform:translateY(6px); }
      to{ opacity:1; transform:translateY(0); }
    }

    /* VERY SMALL PHONES */
    @media(max-width:380px){
      .header{ font-size:17px; }
      .left,.right{ font-size:15.5px; }
    }
  </style>
</head>

<body>

<script>
/* LOGIN GUARD */
if(!localStorage.getItem("token")){
  location="/";
}
</script>

<div class="app">

  <!-- HEADER -->
  <div class="header">
    <span id="chatWith"></span>
  </div>

  <!-- CHAT -->
  <div class="messages" id="messages"></div>

  <!-- INPUT -->
  <div class="input-bar">
    <textarea id="msg" rows="1" placeholder="Type message"></textarea>
    <button id="sendBtn">âž¤</button>
  </div>

</div>

<script>
/* ===== SOCKET SETUP ===== */
const socket = io();
const room = "pratham_adhya";
const sender = localStorage.getItem("username");

const messages = document.getElementById("messages");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const chatWithEl = document.getElementById("chatWith");

/* HEADER NAME */
chatWithEl.innerText =
  sender === "Pratham" ? "Adhya" : "Pratham";

/* AUTO SCROLL */
function scrollToBottom(){
  messages.scrollTop = messages.scrollHeight;
}

/* ADD MESSAGE */
function addMsg(msg, who){
  const d = document.createElement("div");
  d.className = who === sender ? "right" : "left";
  d.innerText = msg;
  messages.appendChild(d);
  scrollToBottom();
}

/* SEND MESSAGE */
function sendMessage(){
  if(!input.value.trim()) return;

  addMsg(input.value, sender);

  socket.emit("send_message", {
    room,
    sender,
    message: input.value
  });

  input.value = "";
}

/* LOAD OLD MESSAGES */
fetch(`/messages/${room}`)
.then(r => r.json())
.then(data => {
  messages.innerHTML = "";
  data.forEach(m => addMsg(m.message, m.sender));
  scrollToBottom();
});

/* JOIN ROOM */
socket.on("connect", () => {
  socket.emit("join", { room });
});

/* RECEIVE MESSAGE */
socket.on("receive_message", data => {
  if(data.sender !== sender){
    addMsg(data.message, data.sender);
  }
});

/* KEYBOARD BEHAVIOR */
input.addEventListener("keydown", e => {
  /* DESKTOP: Enter = Send */
  if(window.innerWidth > 600 && e.key === "Enter"){
    e.preventDefault();
    sendMessage();
  }
});

/* MOBILE: SEND BUTTON */
sendBtn.addEventListener("click", sendMessage);
</script>

</body>
</html>
